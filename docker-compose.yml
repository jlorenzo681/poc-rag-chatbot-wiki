version: '3.8'

services:
  rag-chatbot:
    image: rag-chatbot:latest
    build:
      context: .
      dockerfile: Containerfile
    container_name: rag-chatbot
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "8501:8501"
    environment:

      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}

      - OLLAMA_HOST=http://ollama:11434
      - REDIS_URL=redis://redis:6379/0
    volumes:
      # Persistent data volumes
      - .:/app:z
      - ./data/documents:/app/data/documents:z
      - ./data/vector_stores:/app/data/vector_stores:z
      - ./logs:/app/logs:z
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8501/_stcore/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    networks:
      - rag-network
    depends_on:

      - ollama
      - redis
      - backend

  backend:
    build:
      context: .
      dockerfile: Containerfile
    container_name: rag-backend
    command: uvicorn src.backend.main:app --host 0.0.0.0 --port 8000 --reload --workers 1
    volumes:
      - .:/app:z
      - ./data/documents:/app/data/documents:z
      - ./data/vector_stores:/app/data/vector_stores:z
      - hf-cache:/app/.cache/huggingface:z
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_URL=redis://redis:6379/0
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_HOST=http://ollama:11434

    ports:
      - "8000:8000"
    depends_on:
      - redis
      - ollama
    networks:
      - rag-network

  celery_worker:
    build:
      context: .
      dockerfile: Containerfile
    container_name: rag-worker
    command: celery -A src.backend.celery_config worker --loglevel=info
    volumes:
      - .:/app:z
      - ./data/documents:/app/data/documents:z
      - ./data/vector_stores:/app/data/vector_stores:z
      - ./logs:/app/logs:z
      - hf-cache:/app/.cache/huggingface:z
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_URL=redis://redis:6379/0
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_HOST=http://ollama:11434

    depends_on:
      - redis
    networks:
      - rag-network

  redis:
    image: docker.io/library/redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - rag-network
    volumes:
      - redis-data:/data

  ollama:
    image: docker.io/ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    restart: unless-stopped
    networks:
      - rag-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:11434/api/version" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  neo4j:
    image: docker.io/library/neo4j:5.11
    container_name: neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*

    volumes:
      - neo4j-data:/data
    networks:
      - rag-network

networks:
  rag-network:
    driver: bridge

volumes:
  ollama-data:
  redis-data:
  hf-cache:
  neo4j-data:
